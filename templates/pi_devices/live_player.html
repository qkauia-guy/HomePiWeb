{# templates/pi_devices/live_player.html #}
<!doctype html>
<html lang="zh-Hant">
<head>
  {% load static %}
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>直播：{{ device.label }}｜{{ cap.name }}</title>
  <link rel="icon" href="{% static 'home_pi_web/images/cam.png' %}" type="image/x-icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'home_pi_web/css/base.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body class="bg-body-tertiary d-flex flex-column min-vh-100">
  <!-- 黑夜模式切換按鈕 -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 1000;">
    <button class="btn btn-outline-secondary btn-sm" id="theme-toggle" 
            title="切換黑夜模式" aria-label="切換黑夜模式">
      <i class="bi bi-sun-fill" id="theme-icon"></i>
    </button>
  </div>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="m-0">{{ device.label }}｜{{ cap.name }}</h5>
      <div class="d-flex gap-2">
        <button id="btn-stop" class="btn btn-outline-secondary btn-sm">停止</button>
        <button id="btn-retry" class="btn btn-outline-dark btn-sm">重試</button>
      </div>
    </div>

    <div id="hls-status" class="text-muted small mb-2">初始化…</div>

    <div class="ratio ratio-16x9">
      <video id="player" playsinline muted autoplay controls preload="none"></video>
    </div>

    <div class="mt-3">
      <a class="btn btn-outline-primary btn-sm" target="_blank" href="{{ cam_hls_url }}">開啟 m3u8</a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
  (function () {
    const manifestUrlBase = "{{ cam_hls_url|escapejs }}";
    const startUrl = "{{ start_url|escapejs }}";
    const stopUrl  = "{{ stop_url|escapejs }}";
    const csrfToken = "{{ csrf_token|escapejs }}";
    const groupId = "{{ group_id|escapejs }}";

    const video = document.getElementById("player");
    const statusEl = document.getElementById("hls-status");
    const btnStop = document.getElementById("btn-stop");
    const btnRetry = document.getElementById("btn-retry");

    let hls = null;
    let starting = false;

    function setStatus(t, cls){ statusEl.className="small mb-2 "+(cls||"text-muted"); statusEl.textContent=t; }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
    function cb(u){ return u + (u.includes("?")?"&":"?") + "cb=" + Date.now(); }
    function destroy(){ try{ if(hls) hls.destroy(); }catch(e){} hls=null; }

    async function postAction(url){
      const fd = new FormData();
      if (groupId) fd.append("group_id", groupId);
      fd.append("csrfmiddlewaretoken", csrfToken);
      const r = await fetch(url, {
        method: "POST",
        body: fd,
        credentials: "same-origin",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      if (!r.ok) throw new Error("HTTP "+r.status);
      return r.json().catch(()=> ({}));
    }

    async function ensureStarted(){
      if (starting) return;
      starting = true;
      try {
        setStatus("送出開始指令…");
        await postAction(startUrl);   // 排入 camera_start
        setStatus("等待串流產生…");
      } catch(e){
        setStatus("開始指令失敗："+e, "text-danger");
      } finally { starting = false; }
    }

    async function waitForManifest(){
      let attempt=1;
      for(;;){
        try{
          const u = cb(manifestUrlBase);
          const r = await fetch(u, { cache: "no-store", credentials: "same-origin" });
          const text = await r.text();
          if (r.ok && text.includes("#EXTM3U") && text.trim().length > 10) return u;
          setStatus(`等待串流中…（第 ${attempt} 次）`, "text-warning");
        }catch(e){
          setStatus(`等待串流中…（抓取失敗；第 ${attempt} 次）`, "text-warning");
        }
        await sleep(Math.min(5000, 500*attempt));
        attempt++;
      }
    }

    function play(src){
      if (window.Hls && Hls.isSupported()){
        destroy();
        hls = new Hls({ lowLatencyMode:true, liveSyncDurationCount:3, backBufferLength:0, maxBufferLength:6 });
        hls.attachMedia(video);
        hls.loadSource(src);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ setStatus("播放中…","text-success"); video.play().catch(()=>{}); });
        hls.on(Hls.Events.ERROR, (_e, data)=>{
          if (!data.fatal){ setStatus(`播放警告：${data.details}`,"text-warning"); return; }
          setStatus(`致命錯誤：${data.details}（重試）`,"text-danger");
          start(); // 重新啟動流程
        });
      } else if (video.canPlayType("application/vnd.apple.mpegurl")){
        video.src = src;
        video.addEventListener("loadedmetadata", ()=> video.play().catch(()=>{}), {once:true});
        setStatus("播放中（Safari）","text-success");
      } else {
        setStatus("瀏覽器不支援 HLS（請用 Chrome/Edge 或載入 hls.js）","text-danger");
      }
    }

    async function start(){
      await ensureStarted();
      const src = await waitForManifest();
      play(src);
    }

    btnRetry.addEventListener("click", ()=>{ setStatus("重新嘗試…"); start(); });
    btnStop.addEventListener("click", async ()=>{
      try{ await postAction(stopUrl); setStatus("已停止"); }catch(e){ setStatus("停止失敗："+e,"text-danger"); }
      destroy();
    });

    // 進頁面自動開始
    start();
  })();

  // 黑夜模式 JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const body = document.body;
    
    // 從 localStorage 讀取主題設定，或使用系統偏好
    function getInitialTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        return savedTheme;
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    
    // 設定主題
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      body.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      
      // 更新圖示
      if (theme === 'dark') {
        themeIcon.className = 'bi bi-moon-fill';
        themeToggle.title = '切換到淺色模式';
      } else {
        themeIcon.className = 'bi bi-sun-fill';
        themeToggle.title = '切換到黑夜模式';
      }
    }
    
    // 切換主題
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme') || body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }
    
    // 初始化主題
    setTheme(getInitialTheme());
    
    // 監聽系統主題變化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
      if (!localStorage.getItem('theme')) {
        setTheme(e.matches ? 'dark' : 'light');
      }
    });
    
    // 綁定切換按鈕事件
    themeToggle.addEventListener('click', toggleTheme);
  });
  </script>
</body>
</html>
