<div class="card mb-3">
  <div class="card-body">
    <h5 class="card-title">{{ device.label }}｜{{ cap.name }}</h5>

    <div class="d-flex align-items-center gap-4 flex-wrap">

      {# 開關：電燈 #}
      <div class="form-check form-switch m-0">
        <input
          class="form-check-input cap-toggle"
          type="checkbox"
          role="switch"
          id="lightSwitch-{{ cap.id }}"
          data-auto="#autoSwitch-{{ cap.id }}"
          data-on-url="{% url 'capability_action' device_id=device.id cap_id=cap.id action='on' %}"
          data-off-url="{% url 'capability_action' device_id=device.id cap_id=cap.id action='off' %}"
          data-group="{{ group_id }}"
          data-next=""
          {% if cap.meta.light_is_on %}checked{% endif %}
          {% if cap.meta.auto_light_running %}disabled aria-disabled="true"{% endif %}
        >
        <label class="form-check-label" for="lightSwitch-{{ cap.id }}">電燈</label>
      </div>

      {# 開關：自動感光 #}
      <div class="form-check form-switch m-0">
        <input
          class="form-check-input cap-toggle"
          type="checkbox"
          role="switch"
          id="autoSwitch-{{ cap.id }}"
          data-lock-target="#lightSwitch-{{ cap.id }}"
          data-on-url="{% url 'capability_action' device_id=device.id cap_id=cap.id action='auto_on' %}"
          data-off-url="{% url 'capability_action' device_id=device.id cap_id=cap.id action='auto_off' %}"
          data-group="{{ group_id }}"
          data-next=""
          {% if cap.meta.auto_light_running %}checked{% endif %}
          data-sensor="bh1750-1-23"
          data-led="led_1"
        >
        <label class="form-check-label" for="autoSwitch-{{ cap.id }}">自動</label>
      </div>

      <noscript>
        <div class="d-flex gap-2 flex-wrap mt-2">
          {# 保留你原本的四個按鈕做備援（無 JS 才會顯示） #}
          <form method="post" action="{% url 'capability_action' device_id=device.id cap_id=cap.id action='on' %}" class="cap-form">
            {% csrf_token %}<input type="hidden" name="group_id" value="{{ group_id }}"><button class="btn btn-success btn-sm" type="submit">開燈</button>
          </form>
          <form method="post" action="{% url 'capability_action' device_id=device.id cap_id=cap.id action='off' %}" class="cap-form">
            {% csrf_token %}<input type="hidden" name="group_id" value="{{ group_id }}"><button class="btn btn-secondary btn-sm" type="submit">關燈</button>
          </form>
          <form method="post" action="{% url 'capability_action' device_id=device.id cap_id=cap.id action='auto_on' %}" class="cap-form">
            {% csrf_token %}<input type="hidden" name="group_id" value="{{ group_id }}"><button class="btn btn-info btn-sm" type="submit">啟用自動</button>
          </form>
          <form method="post" action="{% url 'capability_action' device_id=device.id cap_id=cap.id action='auto_off' %}" class="cap-form">
            {% csrf_token %}<input type="hidden" name="group_id" value="{{ group_id }}"><button class="btn btn-dark btn-sm" type="submit">停用自動</button>
          </form>
        </div>
      </noscript>

    </div>
  </div>
</div>
