{% extends "base.html" %}
{% block content %}
<h2>群組：{{ group.name }}</h2>
<p>擁有者：{{ group.owner.email }}</p>

<hr>
<h3>群組裝置</h3>
{% if group_devices %}
  <ul>
    {% for gd in group_devices %}
      <li>
        {{ gd.device.serial_number }}（擁有者：{{ gd.device.user.email }}）
        <span class="text-muted">
          加入者：
          {% if gd.added_by %}
            {{ gd.added_by.email }}
          {% else %}
            未知
          {% endif %}
        </span>

        {% if is_admin %}
          <form method="post" action="{% url 'group_detach_device' group.id gd.device.id %}" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger">從群組移除</button>
          </form>
        {% elif gd.added_by and gd.added_by.id == request.user.id %}
          <form method="post" action="{% url 'group_detach_device' group.id gd.device.id %}" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger">從群組移除</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">目前沒有裝置</p>
{% endif %}

<hr>
<h3>可掛入的我的裝置</h3>
{% if attachable_devices %}
  <ul>
    {% for d in attachable_devices %}
      <li>
        {{ d.serial_number }}
        {% if user_has_grant or is_admin %}
          {# ★ 有授權或是管理員 → 直接掛入 #}
          <form method="post" action="{% url 'group_attach_device' group.id d.id %}" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-sm btn-primary">直接掛入群組</button>
          </form>
        {% else %}
          {# ★ 沒授權 → 送出分享申請 #}
          <form method="post" action="{% url 'request_share_device' group.id d.id %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="message" value="請求分享此裝置">
            <button class="btn btn-sm btn-outline-primary">送出分享申請</button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">你目前沒有可分享（尚未加入本群組）的裝置。</p>
{% endif %}

{% if is_admin %}
<hr>
<h3>待審核的分享申請</h3>
{% if pending_requests %}
<ul>
  {% for r in pending_requests %}
    <li>
      {{ r.requester.email }} 想分享 {{ r.device.serial_number }}
      <form method="post" action="{% url 'review_share_request' group.id r.id %}" style="display:inline;">
        {% csrf_token %}
        <input type="hidden" name="action" value="approve">
        <button type="submit">核准並加入</button>
      </form>
      <form method="post" action="{% url 'review_share_request' group.id r.id %}" style="display:inline;">
        {% csrf_token %}
        <input type="hidden" name="action" value="reject">
        <button type="submit">拒絕</button>
      </form>
    </li>
  {% endfor %}
</ul>
{% else %}
<p>沒有待審核申請</p>
{% endif %}

<hr>
<h3>持續性授權管理</h3>
<ul>
{% for m in memberships %}
  <li>
    {{ m.user.email }}（{{ m.role }}）
    {% if m.user.id in granted_user_ids %}
      <form method="post" action="{% url 'revoke_share_permission' group.id m.user.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit">關閉授權</button>
      </form>
    {% else %}
      <form method="post" action="{% url 'grant_share_permission' group.id m.user.id %}" style="display:inline;">
        {% csrf_token %}
        <input type="number" name="expires_days" placeholder="天數(可空)">
        <button type="submit">開通授權</button>
      </form>
    {% endif %}
  </li>
{% endfor %}
</ul>
{% endif %}

<hr>
<h3>成員列表</h3>
<ul>
  <li>{{ group.owner.email }}（群長）</li>
  {% for m in memberships %}
    <li>{{ m.user.email }}（{{ m.role }}）</li>
  {% endfor %}
</ul>

{% endblock %}
