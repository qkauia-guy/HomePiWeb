{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      
      <!-- 毛玻璃卡片容器 -->
      <div class="glass-card">
        <div class="card-header glass-header">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
              <h2 class="card-title mb-1">
                <i class="fas fa-users me-2"></i>
                {{ group.name }}
              </h2>
              <p class="card-subtitle text-muted mb-0">
                <i class="fas fa-crown me-1"></i>
                群長：{{ group.owner.email }}
              </p>
            </div>
            <div class="d-flex gap-2">
              <a class="btn btn-outline-primary" href="{% url 'group_members' group.id %}">
                <i class="fas fa-user-plus me-2"></i>
                邀請成員
              </a>
            </div>
          </div>
        </div>
        
        <div class="card-body glass-body">

          <!-- 群組裝置區域 -->
          <div class="section-header mb-3">
            <h4 class="section-title">
              <i class="fas fa-desktop me-2"></i>
              群組裝置
            </h4>
          </div>
          
          {% if group_devices %}
            <div class="table-responsive glass-table">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width:32%;">裝置</th>
                    <th style="width:20%;">狀態</th>
                    <th style="width:18%;">上次連結時間</th>
                    <th class="text-end" style="width:10%;">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for gd in group_devices %}
                    <tr>
                      <td>
                        <div class="fw-semibold">{{ gd.device.label }}</div>
                        <div class="small text-secondary">SN: {{ gd.device.serial_number }}</div>
                      </td>
                      <td class="small text-secondary">啟用中</td>
                      <td class="small text-secondary">
                        {% if gd.device.last_ping %}
                          {{ gd.device.last_ping|timesince }} 前
                        {% else %}
                          無
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {% if is_admin or gd.added_by_id == user.id %}
                          <form method="post" action="{% url 'group_detach_device' group.id gd.device.id %}" class="d-inline">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-outline-danger">移除</button>
                          </form>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-state">
              <i class="fas fa-desktop fa-2x text-muted mb-3"></i>
              <p class="text-muted mb-0">目前沒有裝置</p>
            </div>
          {% endif %}

          <!-- 分隔線 -->
          <hr class="section-divider">
          
          <!-- 成員列表區域 -->
          <div class="section-header mb-3">
            <h4 class="section-title">
              <i class="fas fa-users-cog me-2"></i>
              成員列表
            </h4>
          </div>
          
          <div class="table-responsive glass-table">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width:32%;">成員</th>
                  <th style="width:12%;">角色</th>
                  <th>裝置權限</th>
                  <th class="text-end" style="width:26%;">操作</th>
                </tr>
              </thead>
        <tbody>

          {# 群長固定第一列 #}
          <tr>
            <td>
              <div class="fw-semibold">{{ group.owner.email }}</div>
              <div class="small text-secondary">（群長）</div>
            </td>
            <td><span class="badge text-bg-info">OWNER</span></td>
            <td>
              {% if group_devices %}
                <span class="badge bg-success-subtle border text-success">
                  全部可控（{{ group_devices|length }} 台）
                </span>
              {% else %}
                <span class="text-secondary">（此群組尚無裝置）</span>
              {% endif %}
            </td>
            <td class="text-end">
              <span class="text-secondary">（群長不可退出 / 不可被移除）</span>
            </td>
          </tr>

          {# 其它成員 #}
          {% for ms in memberships %}
          <tr>
            <td>
              <div class="fw-semibold">{{ ms.user.email }}</div>
              <div class="small text-secondary">加入：{{ ms.joined_at|date:"Y-m-d H:i" }}</div>
            </td>

            <td>
              <span class="badge text-bg-secondary text-uppercase">{{ ms.get_role_display }}</span>
            </td>

            <td class="small">
              {% if ms.user_id == group.owner_id or ms.role == 'admin' %}
                <span class="badge bg-success-subtle border text-success">
                  全部可控（{{ group_devices|length }} 台）
                </span>
              {% elif ms.role == 'viewer' %}
                <span class="badge bg-secondary-subtle border text-muted">
                  不可操作（{{ group_devices|length }} 台）
                </span>
              {% else %}
                {% if group_devices %}
                  {% for gd in group_devices %}
                    {% if gd.device.id in ms.allowed_ids %}
                      <span class="badge bg-success-subtle border text-success me-1" title="可操作" data-bs-toggle="tooltip">
                        {{ gd.device.label }}
                      </span>
                    {% else %}
                      <span class="badge bg-secondary-subtle border text-muted me-1" title="不可操作" data-bs-toggle="tooltip">
                        {{ gd.device.label }}
                      </span>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <span class="text-secondary">（此群組尚無裝置）</span>
                {% endif %}
              {% endif %}
            </td>

            <td class="text-end">
              <div class="d-inline-flex gap-2 align-items-center flex-wrap justify-content-end">

                {# 只有本人且不是群長 → 退出群組 #}
                {% if ms.user_id == user.id and user.id != group.owner_id %}
                <form method="post"
                      action="{% url 'group_leave' group.id %}"
                      onsubmit="return confirm('確定要退出此群組？');">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger">退出群組</button>
                </form>
                {% endif %}

                {# Admin 對別人可操作（不可動群長/自己） #}
                {% if is_admin and ms.user_id != group.owner_id and ms.user_id != user.id %}
                  <!-- 改角色 -->
                  <form method="post" action="{% url 'member_set_role' group.id ms.id %}" class="d-flex gap-2">
                    {% csrf_token %}
                    <select name="role" class="form-select form-select-sm" style="width:150px;">
                      {% for value,label in role_choices %}
                        <option value="{{ value }}" {% if ms.role == value %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">更新</button>
                  </form>

                  {# operator 才能編輯裝置權限 #}
                  {% if ms.role == 'operator' %}
                    <button class="btn btn-sm btn-outline-secondary"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#acl-row-{{ ms.id }}">
                      權限
                    </button>
                  {% endif %}

                  <!-- 移除成員 -->
                  <form method="post"
                        action="{% url 'member_remove' group.id ms.id %}"
                        onsubmit="return confirm('確定要移除此成員嗎？');">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" type="submit">移除</button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>

          {# ACL 編輯面板（放在下一列，同一個 tbody；使用 div.collapse 比 tr.collapse 穩定） #}
          {% if is_admin and ms.role == 'operator' and ms.user_id != group.owner_id and ms.user_id != user.id %}
          <tr>
            <td colspan="4" class="p-0">
              <div class="collapse border-top" id="acl-row-{{ ms.id }}">
                <div class="p-3">
                  <form method="post" action="{% url 'member_device_acl' group.id ms.user.id %}">
                    {% csrf_token %}
                    <div class="row g-2 align-items-center">
                      {% for gd in group_devices %}
                        <div class="col-sm-6 col-md-4 col-lg-3">
                          <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   name="dev[]"
                                   value="{{ gd.device.id }}"
                                   id="dev-{{ ms.id }}-{{ gd.device.id }}"
                                   {% if gd.device.id in ms.allowed_ids %}checked{% endif %}>
                            <label class="form-check-label" for="dev-{{ ms.id }}-{{ gd.device.id }}">
                              {{ gd.device.label }}
                            </label>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                    <div class="mt-3 d-flex gap-2">
                      <button class="btn btn-sm btn-primary" type="submit">儲存權限</button>
                      <button class="btn btn-sm btn-outline-secondary" type="button"
                              data-bs-toggle="collapse" data-bs-target="#acl-row-{{ ms.id }}">
                        關閉
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </td>
          </tr>
          {% endif %}

          {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- 可掛入的我的裝置 -->
        {# 只有群長看得到這一區 #}
        {% if user.id == group.owner_id %}
          <!-- 分隔線 -->
          <hr class="section-divider">
          
          <div class="section-header mb-3">
            <h4 class="section-title">
              <i class="fas fa-plus-circle me-2"></i>
              可掛入的我的裝置
            </h4>
          </div>
          
          {% if attachable_devices %}
            <div class="attachable-devices">
              {% for d in attachable_devices %}
                <div class="device-item d-flex justify-content-between align-items-center p-3 mb-2">
                  <div>
                    <div class="fw-semibold">{{ d.label }}</div>
                    <div class="small text-secondary">SN: {{ d.serial_number }}</div>
                  </div>
                  <div class="ms-3">
                    <form method="post" action="{% url 'group_attach_device' group.id d.id %}" class="d-inline">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-primary">
                        <i class="fas fa-link me-1"></i>
                        直接掛入
                      </button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <i class="fas fa-plus-circle fa-2x text-muted mb-3"></i>
              <p class="text-muted mb-0">目前沒有可掛入的裝置</p>
            </div>
          {% endif %}
        {% endif %}
        
        </div> <!-- 結束 glass-body -->
      </div> <!-- 結束 glass-card -->
      
    </div> <!-- 結束 col -->
  </div> <!-- 結束 row -->
</div> <!-- 結束 container-fluid -->
{% endblock %}
