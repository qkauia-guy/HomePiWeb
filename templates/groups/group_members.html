{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">「{{ group.name }}」成員管理</h2>

  <!-- 新增成員表單 -->
  <div class="card mb-4">
    <div class="card-header">建立邀請</div>
    <div class="card-body">
      <form method="post" action="{% url 'group_members' group.id %}">
        {% csrf_token %}
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label" for="id_email">Email</label>
            {{ form.email }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="id_role">角色</label>
            {{ form.role }}
          </div>
          <div class="col-md-3">
            <label class="form-label" for="id_device">裝置</label>
            {{ form.device }}
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">加入</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- 成員列表 -->
  <div class="card">
    <div class="card-header">成員列表</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:60px;">#</th>
              <th>Email</th>
              <th>角色</th>
              <th>加入時間</th>
              <th style="width:300px;">操作</th>
            </tr>
          </thead>
          <tbody>
            {% for ms in memberships %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ ms.user.email }}</td>
              <td>
                <!-- 以模型顯示名稱呈現（Admin / Operator / Viewer） -->
                <span class="badge bg-secondary text-uppercase">{{ ms.get_role_display }}</span>
              </td>
              <td>{{ ms.joined_at|date:"Y-m-d H:i" }}</td>
              <td>
                <div class="d-flex gap-2">
                  {% if ms.user_id != request.user.id %}
                    <!-- 更新角色：用模型 choices 迭代，避免手動寫錯 -->
                    <form method="post" action="{% url 'member_set_role' group.id ms.id %}" class="d-flex gap-2">
                      {% csrf_token %}
                      <select name="role" class="form-select form-select-sm" style="width:160px;">
                        {% for value,label in role_choices %}
                          <option value="{{ value }}" {% if ms.role == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-sm btn-outline-primary" type="submit">更新角色</button>
                    </form>

                    <!-- 移除成員 -->
                    <form method="post" action="{% url 'member_remove' group.id ms.id %}" onsubmit="return confirm('確定要移除此成員嗎？');">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" type="submit">移除</button>
                    </form>
                  {% else %}
                    <span class="text-muted">（無法變更/移除自己）</span>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">目前無成員</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a class="btn btn-outline-secondary" href="{% url 'group_detail' group.id %}">回群組</a>
  </div>
</div>
{% endblock %}
