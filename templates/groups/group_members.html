{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">「{{ group.name }}」成員管理</h2>

  {# 新增成員表單 #}
  <div class="card mb-4">
    <div class="card-header">新增成員</div>
    <div class="card-body">
      <form method="post" action="{% url 'group_members' group.id %}">
        {% csrf_token %}
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label" for="id_email">Email</label>
            {{ form.email }}
          </div>
          <div class="col-md-4">
            <label class="form-label" for="id_role">角色</label>
            {{ form.role }}
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">加入</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# 成員列表 #}
  <div class="card">
    <div class="card-header">成員列表</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:60px;">#</th>
              <th>Email</th>
              <th>角色</th>
              <th>加入時間</th>
              <th style="width:260px;">操作</th>
            </tr>
          </thead>
          <tbody>
            {% for ms in memberships %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ ms.user.email }}</td>
              <td>
                {# 顯示目前角色 #}
                <span class="badge bg-secondary text-uppercase">{{ ms.role }}</span>
              </td>
              <td>
                {# 依你的模型欄位調整，常見是 created_at 或 date_joined #}
                {{ ms.created_at|default:ms.created|date:"Y-m-d H:i" }}
              </td>
              <td>
                <div class="d-flex gap-2">

                  {# 更新角色 #}
                  <form method="post" action="{% url 'member_set_role' group.id ms.id %}" class="d-flex gap-2">
                    {% csrf_token %}
                    <select name="role" class="form-select form-select-sm" style="width:140px;">
                      <option value="member" {% if ms.role == "member" %}selected{% endif %}>成員</option>
                      <option value="admin"  {% if ms.role == "admin"  %}selected{% endif %}>管理員</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">更新角色</button>
                  </form>

                  {# 移除成員 #}
                  <form method="post" action="{% url 'member_remove' group.id ms.id %}" onsubmit="return confirm('確定要移除此成員嗎？');">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger" type="submit">移除</button>
                  </form>

                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">目前無成員</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <a class="btn btn-outline-secondary" href="{% url 'group_detail' group.id %}">回群組</a>
  </div>
</div>
{% endblock %}
