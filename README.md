<!-- markdownlint-disable -->

#### ＊設備初始設定建構：

1. 每組設備擁有一組**QRcode**和**密碼**，讓用戶連結建立帳號、開通設備、綁定設備
2. 用戶開通設備，設定用戶 ping 到樹梅派

| 流程                                              | 說明                                                                                 | 備註                                      |
| ------------------------------------------------- | ------------------------------------------------------------------------------------ | ----------------------------------------- |
| ① 設備出廠                                        | 樹梅派（或 ESP32）會有一組唯一設備 ID、對應初始密碼、QR Code（可編碼為網址 + token） | ex: https://example.com/bind?token=abc123 |
| ② 用戶掃碼                                        | 掃描 QR Code → 導向「用戶註冊和開通設備頁面」                                        | 前端用手機開啟                            |
| ③ 輸入驗證備密碼                                  | 驗證是合法擁有者                                                                     | 確保不是亂掃亂綁                          |
| ④ 綁定帳號 + 開通設備                             | 建立 Device.user_id = request.user.id，同時設備進入啟用狀態                          | 開始記錄使用者是誰開通的                  |
| ⑤ 通知樹梅派設備                                  | Django 發一個 ping / POST 給該設備 IP，讓設備得知「被誰開通了」                      | 可做基本 handshake，例如 POST /register   |
| ⑥ 設備收到 user_id 或 token 後登入平台 / 記錄狀態 | 樹梅派可以將資訊儲存本地或回報                                                       | 建立起雙向綁定基礎                        |

---

#### ＊使用者角色:

- **SuperAdmin**： 擁有裝置密碼的角色,具有最高權限(一台裝置只有一位 SuperAdmin)，管理群組、指派 Admin 權限，管理設備參數。
- **Admin**： 被授權管理設備的角色(不能直接註冊)，協助管理管理設備參數，但不能管理群組和指派權限。
- **User**： 一般使用者角色(受邀請連結註冊的用戶)，只能操作最基本的設備行為。

#### ＊權限比較表：

| 權限                                     | User | Admin | SuperAdmin |
| ---------------------------------------- | ---- | ----- | ---------- |
| 操作智能家電                             | ✅   | ✅    | ✅         |
| 編輯個人資料                             | ✅   | ✅    | ✅         |
| 設定設備參數（基本參數，如風速）         | ✅   | ✅    | ✅         |
| 設定設備參數（環境參數，如自動觸發條件） | ❌   | ✅    | ✅         |
| 設備重命名                               | ❌   | ✅    | ✅         |
| 成員邀請 / 建立註冊頁                    | ❌   | ❌    | ✅         |
| 成員加入審核 / 通知查看                  | ❌   | ❌    | ✅         |
| 指定/取消 Admin 權限                     | ❌   | ❌    | ✅         |
| 群組建立 / 刪除                          | ❌   | ❌    | ✅         |

##### ▶ User 權限：

1. 會員資料修改
2. 智能家電操作

##### ▶ Admin 權限：

0. 包含 **User 權限**
1. 後台管理：

- **設備管理：**
  - 設備自訂義名稱
  - 家電設備參數設定

##### ▶ SuperAdmin 使用者權限：

0. 包含 **User 權限** 以及 **Admin 權限**
1. 群組管理 建立 / 移除
2. **授權 Admin 權限** / **移除 Admin 權限**
3. 後台管理：

- **設備管理：**
  - 設備自訂義名稱
  - 家電設備參數設定
- **成員管理：**
  - 生成分享邀請成員頁面 (時效性生成一般成員註冊頁面)
  - 成員加入通知
  - 成員加入審核

---

#### ＊模組功能：

1. 解鎖：

- 人臉辨識：
  - 設定方式： 現在完全沒概念
- 遠端解鎖：
  - 解鎖安全參數調整： 分高低安全等級，根據等級來實現解鎖條件
    - 低安全度解鎖方式：不需驗證或是特別的操作就可以解鎖
    - 高安全度解鎖方式：可能要雙重驗證之類才能解鎖
- 進出紀錄：
  - 計算進出次數
  - 顯示有誰在家(已有辨識人臉的人數)
  - 家裡總共幾個人
- 自定義通知參數：
  - 門口警告/歡迎通知：特定人臉設定門口通知方式(警告或歡迎)
  - 陌生人通知：幫陌生人拍照存證之類
  - 一律遠端通知：用戶即時通知

2. 監控：

- 遠端即時監控：
- 錄影：
  - 設定自動錄影時段
  - 設定解析度
  - 回放錄影
- 自定義通知參數：
  - 記憶卡即將滿
  - 間格性回傳家裡影像影片

3. 智能家電：

- 電風扇：
  - 遠端控制： 控制開關方向風速
  - 自動控制： 溫度感應自動控制風速
  - 耗電量統計
- 電燈開關：
  - 遠端控制：控制開關明亮度
  - 自動控制：明亮感應自動啟動點燈數量以及亮度
  - 耗電量統計

---

#### ＊通知機制：

- 會員/群組通知
- 設備通知

---

#### ＊頁面操作流程：

- 後台管理頁面： 預設後台設備管理列表
- 後台設備列表頁面：會顯示當前設備的 SuperAdmin 擁有者
- 後台群組管理頁面：預設後台群組列表
- 如果原先只是 User，開通新裝置角色直接升為 SuperAdmin

###### ▶ 初次註冊(SuperAdmin)：🅥

1. 機器擁有者(Admin)掃機台上的 QRcode(帶入 token)
2. 進入**SuperAdmin**註冊頁面
3. 點選還不是會員，進行註冊
4. **驗證機台密碼**
5. 填入基本表單(會員資料)
6. alert 註冊成功
7. 轉跳<u>後台管理頁面(後台設備列表)</u>
8. 發送註冊成功歡迎通知(通知分類：會員群組/個人)

###### ▶ 新設備開通(已經是會員)-允許群組共享設備(SuperAdmin)：🅥

1. 機器擁有者(Admin)掃機台上的 QRcode
2. 進入**SuperAdmin**註冊頁面
3. 點選<u>已經是會員，開通設備</u>
4. **驗證機台密碼**
5. 轉跳<u>設備權限設定頁面</u>
6. 設備是否群組共享？Yes
7. 設備開通設定成功
8. 轉跳<u>後台管理(後台設備列表)</u>
9. 發送開通成功通知(通知分類：會員群組/群組)

> 備註：如果原先只是 User 角色，開通新設備角色直接升為 SuperAdmin

###### ▶ 新設備開通-不共享設備(SuperAdmin)：🅥

1. 機器擁有者(Admin)掃機台上的 QRcode
2. 進入**SuperAdmin**註冊頁面
3. 點選<u>已經是會員，開通設備</u>
4. **驗證機台密碼**
5. 轉跳<u>設備權限設定頁面</u>
6. 設備是否群組共享？No
7. 設備開通設定成功
8. 轉跳<u>後台管理(後台設備列表)</u>
9. 發送開通成功通知(通知分類：會員群組/個人)

> 備註：如果原先只是 User 角色，開通新設備角色直接升為 SuperAdmin。
> 可以選擇群組不共享設備或是自己建立新群組
> 當然也可以不授權 Admin 權限

###### ▶ 後台群組管理-建立群組(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 點選建立群組
3. 輸入群組表單
4. 建立群組成功
5. 轉跳<u>群組列表</u>
6. 發送建立群組通知(通知分類：會員群組/個人)

###### ▶ 後台群組管理-編輯群組(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 點選編輯群組
3. 輸入更新群組資訊
4. 更新群組成功
5. 轉跳<u>群組列表</u>
6. 發送更新群組通知(通知分類：會員群組/群組)

###### ▶ 後台群組管理-刪除群組(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 點選刪除群組
3. 驗證 Admin 密碼
4. alert 提醒刪除動作
5. alert 刪除群組成功
6. 後端移除成員分享過的權限
7. 轉跳<u>群組管理(群組列表)</u>
8. 發送刪除群組通知(通知分類：會員群組/群組)

###### ▶ 後台邀請成員(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 進入<u>成員管理(成員列表)</u>
3. 點選新增成員
4. 確認分享的設備資訊
5. 分享邀請成員連結(帶入時效 token，一次性使用)
6. 選擇分享方式(Email, Line?)
7. alert 分享成功
8. 轉跳<u>成員管理(成員列表)</u>
9. 發送邀請成功通知(通知分類：會員群組/雙方)

###### ▶ 後台移除成員(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 進入<u>成員管理(成員列表)</u>
3. 點選刪除成員
4. 刪除 alert 提醒
5. 驗證 SuperAdmin 的密碼
6. 轉跳<u>成員管理(成員列表)</u>
7. 發送移除成功通知(通知分類：會員群組/群組)

###### ▶ 後台群組共享和授權 Admin 權限(SuperAdmin)：🅥

0. <u>後台管理頁面(後台設備列表)</u>
1. 進入<u>群組管理(群組列表)</u>
2. 是否授權設備權限? Yes
3. 勾選授權 User Name
4. 授權送出
5. 授權成功
6. 轉跳<u>群組管理(群組列表)</u>
7. 發送授權成功通知(通知分類：會員群組/群組)

###### ▶ 後台設備管理(SuperAdmin, Admin)：

0. <u>後台管理頁面(後台設備列表)</u>
1. 對應設備點選設定
2. 摺疊區塊顯示表單設定參數
3. 設定成功
4. 轉跳<u>後台管理頁面(後台設備列表)</u>
5. 發送設定成功通知(通知分類：設備/SuperAdmin, Admin)

###### ▶ 修改會員資料(SuperAdmin, Admin, User)：

0. navbar 點選修改會員資料
1. 進入表單修正
2. 確認密碼
3. 送出
4. 發送授權成功通知(通知分類：會員群組/個人)

###### ▶ 忘記密碼(初始化)(SuperAdmin)：

0. 登入頁面
1. 點選忘記密碼
2. alert 提醒密碼重置設備將會初始化
3. 確認設備重置初始化
4. 輸入設備密碼
5. 設備資料清除重置
6. 請重新掃描設備 QRcode 進行註冊

> 目前沒有 e-mail 通知功能，尚可討論密碼重設方式

###### ▶ 忘記密碼(Admin, User)：

0. 登入頁面
1. 點選忘記密碼
2. 將重設密碼請求轉為通知 SuperAdmin
3. 輸入預設密碼登入
4. 轉跳修改密碼頁面
5. 修改密碼
6. 發送修改密碼成功通知(通知分類：會員群組/個人)

> SuperAdmin 在後台群主管理/成員管理/選擇該用戶重設密碼
> 目前沒有 e-mail 通知功能，尚可討論密碼重設方式

###### ▶ 加入群組(Admin, User)：🅥

0. 點擊分享連結
1. 確認登入狀況(如果為登入轉跳到<u>登入頁面</u>)
2. 確認設備資訊
3. 點擊確認加入群組
4. 轉跳<u>群組管理(群組列表)</u>
5. 發送加入成功通知(通知分類：會員群組/群組)

###### ▶ 加入群組(未註冊會員狀況)：🅥

0. 點擊分享連結
1. 確認登入狀況(如果為登入轉跳到<u>登入頁面</u>)
2. **若沒有帳號**前往<u>註冊頁面</u>
3. 確認設備資訊
4. 點擊確認加入群組
5. 轉跳<u>群組管理(群組列表)</u>
6. 發送加入成功通知(通知分類：會員群組/群組)

###### ▶ 不加入群組(Admin, User)：🅥

0. 點擊通知
1. 確認登入狀況(如果為登入轉跳到<u>登入頁面</u>)
2. **若沒有帳號**前往<u>註冊頁面</u>
3. 確認設備資訊
4. 點擊不加入群組
5. 轉跳<u>首頁</u>
6. 發送拒絕加入通知(通知分類：會員群組/SuperAdmin)

###### ▶ 前台設備控制(SuperAdmin, Admin, User)：

0. <u>前台設備列表(首頁)</u>
1. 所有設備狀態、開關、控制都在同一個頁面操作呈現
2. 有權限的角色可以顯示其他控制連結進行參數設定

#### ＊頁面整理：

| 編號 | 頁面名稱                         | 說明                                          |
| ---- | -------------------------------- | --------------------------------------------- |
| 1    | 登入頁面                         | 含「忘記密碼」按鈕                            |
| 2    | 註冊頁（SuperAdmin / 一般成員）  | 同一個頁面透過 QR/Token 判斷進哪種註冊模式    |
| 3    | 重設密碼頁                       | 輸入預設密碼或 QR 驗證後 → 新密碼設定         |
| 4    | 修改會員資料頁                   | 所有角色共用，依權限控制欄位                  |
| 5    | 設備開通頁（QR 驗證 + 權限設定） | 原本兩頁整合為一頁：驗證後進入共享設定        |
| 6    | 前台設備控制頁                   | 所有有權限的用戶共用                          |
| 7    | 群組列表 + 群組建立/編輯共用頁   | 建立 / 編輯群組使用同一個表單 template        |
| 8    | 成員列表 + 邀請 / 移除共用頁     | 操作用 modal 彈出邀請或移除                   |
| 9    | 設備列表 + 設定共用頁            | 點設備進行參數設定 / 重命名（右側或下方展開） |
| 10   | 忘記密碼（SuperAdmin）頁         | 設備初始化流程                                |
| 11   | 授權管理頁                       | 授權 Admin、共享設備 → 可用 checkbox 控制     |
| 12   | 加入群組頁                       | 點擊邀請連結 → 確認加入或拒絕群組             |
| 13   | 訊息通知頁                       | 若你要有系統通知記錄，可集中在這一頁          |

精簡後頁數總計：13 頁

---

#### ＊系統技術架構（本地開發）

| 類別     | 技術/工具                    |
| -------- | ---------------------------- |
| 前端     | Node.js + React              |
| 後端     | Python + Django + DRF        |
| 資料庫   | **MySQL（phpMyAdmin 管理）** |
| 通知服務 | Discord Bot（本機執行）      |
| 虛擬環境 | Poetry + `.venv`             |

> Django REST Framework 是一個 專門用來建立 API 的 Django 擴充工具包，幫助你把資料（例如資料庫中的模型）變成前端（例如 React）或其他裝置能讀懂的 JSON 格式 API。

---

#### 資料架構：

###### ▶ User（使用者）

| 欄位名稱   | 資料型別              | 說明               |
| ---------- | --------------------- | ------------------ |
| id         | Integer (Primary Key) | 使用者主鍵 ID      |
| email      | EmailField            | 使用者信箱（唯一） |
| password   | CharField(128)        | 密碼（加密儲存）   |
| name       | CharField(50)         | 使用者姓名         |
| is_admin   | BooleanField          | 是否為管理員       |
| created_at | DateTimeField         | 註冊時間           |

---

###### ▶ RaspberryPi（樹莓派主機）

| 欄位名稱       | 資料型別              | 說明           |
| -------------- | --------------------- | -------------- |
| id             | Integer (Primary Key) | 主鍵 ID        |
| name           | CharField(50)         | 主機名稱       |
| ip_address     | IPAddressField        | IP 位址        |
| memory_status  | CharField(50)         | 記憶體使用狀態 |
| storage_status | CharField(50)         | 硬碟使用狀態   |
| created_at     | DateTimeField         | 建立時間       |

---

###### ▶ Module（模組）

| 欄位名稱     | 資料型別                 | 說明                                 |
| ------------ | ------------------------ | ------------------------------------ |
| id           | Integer (Primary Key)    | 模組 ID                              |
| name         | CharField(20)            | 模組名稱（例如：解鎖 / 監控 / 家電） |
| raspberry_pi | ForeignKey → RaspberryPi | 所屬的樹莓派主機（外鍵）             |

---

###### ▶ OperationLog（操作紀錄）

| 欄位名稱        | 資料型別              | 說明               |
| --------------- | --------------------- | ------------------ |
| id              | Integer (Primary Key) | 紀錄 ID            |
| user            | ForeignKey → User     | 操作者（外鍵）     |
| module          | ForeignKey → Module   | 操作的模組（外鍵） |
| action          | CharField(100)        | 操作行為描述       |
| timestamp       | DateTimeField         | 操作時間           |
| additional_info | TextField             | 補充資訊（選填）   |

---

###### ▶ UnlockSchedule / RecordSchedule（排程設定）

| 欄位名稱   | 資料型別              | 說明             |
| ---------- | --------------------- | ---------------- |
| id         | Integer (Primary Key) | 主鍵 ID          |
| module     | ForeignKey → Module   | 所屬模組（外鍵） |
| start_time | TimeField             | 開始時間         |
| end_time   | TimeField             | 結束時間         |

---

###### ▶ SmartDevice（智能裝置）

| 欄位名稱    | 資料型別              | 說明                   |
| ----------- | --------------------- | ---------------------- |
| id          | Integer (Primary Key) | 裝置 ID                |
| module      | ForeignKey → Module   | 所屬模組（外鍵）       |
| device_type | CharField(10)         | 裝置類型（風扇、燈等） |
| is_on       | BooleanField          | 開啟狀態               |
| auto_mode   | BooleanField          | 自動控制               |
| power_usage | FloatField            | 耗電量（kWh）          |
| updated_at  | DateTimeField         | 最後更新時間           |

---

###### ▶ Notification（通知）

| 欄位名稱  | 資料型別              | 說明             |
| --------- | --------------------- | ---------------- |
| id        | Integer (Primary Key) | 通知 ID          |
| user      | ForeignKey → User     | 接收者（外鍵）   |
| module    | ForeignKey → Module   | 所屬模組（外鍵） |
| content   | TextField             | 通知內容         |
| timestamp | DateTimeField         | 發送時間         |
| is_sent   | BooleanField          | 是否已發送       |

---

#### ＊Python 套件依賴

```toml
[tool.poetry.dependencies]
python = "^3.11"
django = "*"
djangorestframework = "*"
mysqlclient = "*"
python-decouple = "*"
discord.py = "*"
```

---

#### ＊.env 設定（對應 phpMyAdmin）

```env
SECRET_KEY=your-secret
DEBUG=True
DB_NAME=school_db
DB_USER=root
DB_PASSWORD=123456
DB_HOST=127.0.0.1
DB_PORT=3306
```

---

#### ＊啟動方式（本地端）

```bash
# 啟動 Django 後端
source .venv/bin/activate
python manage.py runserver

# 啟動 React 前端
cd frontend
npm install
npm start
```

---

#### ＊Discord Bot 結構建議

```
backend/apps/notifications/
├── discord_bot/
│   ├── bot.py
│   └── sender.py
```

> Bot 可本地運行，自資料庫中讀取事件通知使用者。

---
