## 多台樹梅派「同步誤動作」排查指南

當你操作 A 樹梅派的開燈，B 樹梅派的實體燈也跟著亮，最常見原因是兩台用了同一組 SERIAL/TOKEN，被後端視為同一台裝置來拉取與執行指令。以下提供快速檢查與修復步驟。

### 常見症狀

- A 在線、B 離線；操作 A 後，B 的實體燈也亮或行為一致。
- 後端的 `Device` 記錄中，`ip_address` 在兩個 IP 間來回切換。

### 主要成因

1. 兩台樹梅派的 `.env` 使用了「相同的」`SERIAL` 與 `TOKEN`（最常見）。
2. B 之前啟用了自動感光（`auto_light_on`），在本機依環境亮度自行開燈（與 A 無關，但現象像同步）。
3. 配線或 YAML 腳位設定共用，導致兩台實際控制同一條電路（較少見）。

---

## 快速檢查

### 1) 檢查兩台的 `.env`（SERIAL/TOKEN 必須唯一）

在 A、B 各自執行：

```bash
grep -E '^(SERIAL|TOKEN|API_BASE)=' /Users/qkauia/Desktop/HomePiWeb/pi_agent/env || cat /Users/qkauia/Desktop/HomePiWeb/.env
```

比對輸出：

- `SERIAL` 與 `TOKEN` 兩台不可相同。
- `API_BASE` 指向你的 Django 後端（例如 `http://<server-ip>:8800`）。

### 2) 檢查 agent 日誌（是否兩台都在拉同一批指令）

```bash
journalctl -u homepi-agent@pi.service -f | grep -E 'pull got|ack ok|auto_light'
```

- 若 A、B 都出現相同時間的 `pull got`/`ack ok`，且是同一動作，代表可能共用憑證。

### 3) 後端資料核對（可選）

- `Device.serial_number`：A、B 是否各自一筆？
- `Device.ip_address` 是否在兩個 IP 間來回跳？
- `DeviceCommand` 是否都落在同一個 device 上？

---

## 修復步驟

### 情境 A：兩台用到同一組 SERIAL/TOKEN（最可能）

1. 在後端為 B 建立「新的」裝置（可用 QR 流程或管理後台）。
2. 取得 B 的 `serial_number` 與 `token`，填入 B 的 `.env`：

```bash
sed -i 's/^SERIAL=.*/SERIAL=PI-NEWBXXXX/' /Users/qkauia/Desktop/HomePiWeb/pi_agent/env
sed -i 's/^TOKEN=.*/TOKEN=NEWB_TOKEN_VALUE/' /Users/qkauia/Desktop/HomePiWeb/pi_agent/env
```

3. 重啟 B 的 agent：

```bash
systemctl restart homepi-agent@pi.service
```

> 若不用 systemd，則：

```bash
conda activate homepi-agent
python -m pi_agent.http_agent
```

### 情境 B：B 的自動感光仍在運作

1. 從後端對 B 送 `auto_light_off` 指令，或在 B 上重啟 agent。
2. 確認 `config/homepi.yml` 的 `auto_light.enabled` 預設為 `false`，避免開機自動啟用。

### 情境 C：硬體共線或 YAML 腳位設定錯誤

1. 檢查兩台的 LED 接線是否獨立，沒有共用同一繼電器或 GPIO。
2. 檢查兩台的 `config/homepi.yml`：
   - `devices.kind: led` 的 `pin` 值是否各自不同、符合實體配線。
   - 若未使用 YAML，`.env` 的 `LED_PIN` 是否意外設成同一腳位。

---

## 後端防呆建議（可選）

- 將 `serial+token` 當作裝置唯一憑證，並在 `device_pull` 記錄最近使用者的 agent 指紋（可用隨機 UUID）。短時間內被不同指紋使用則拒絕或告警。
- 偵測「同一裝置在短時間內於不同 IP 之間來回切換」→ 發通知。

---

## 常用指令速查

```bash
# 查看 .env 關鍵值
grep -E '^(SERIAL|TOKEN|API_BASE)=' /Users/qkauia/Desktop/HomePiWeb/pi_agent/env || cat /Users/qkauia/Desktop/HomePiWeb/.env

# 追蹤 agent 日誌
journalctl -u homepi-agent@pi.service -f

# 重啟 agent（systemd）
systemctl restart homepi-agent@pi.service

# 手動啟動（無 systemd）
conda activate homepi-agent && python -m pi_agent.http_agent
```



