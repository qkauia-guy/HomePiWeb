<!-- markdownlint-disable -->

### 樹梅派專案資料結構：

```bash
pi_agent
├─ config/                 # 設定與能力宣告
│  ├─ __init__.py
│  ├─ capabilities.json    # (靜態) 宣告此樹莓派可提供的capabilities（ex: camera, led...）
│  ├─ homepi.yml           # (動態) 執行環境設定：伺服器URL、序號、token、HLS參數等
│  └─ loader.py            # 載入 YAML/JSON、提供預設值、環境變數覆寫、驗證
│
├─ detect/                 # 硬體偵測（開機時用）
│  ├─ __init__.py
│  ├─ hat.py               # 檢測 HAT 擴充板（型號、版本）
│  ├─ i2c.py               # 掃 I²C bus，列出感測器
│  ├─ one_wire.py          # 偵測 1-Wire 裝置（如溫度計）
│  └─ registry.py          # 整合結果 → 回報到 capabilities.json 或上報伺服器
│
├─ devices/                # 實際控制裝置（驅動）
│  ├─ __init__.py
│  ├─ camera.py            # 控相機：開始/停止推流、查狀態；呼叫 rpicam-vid/ffmpeg 或 pipe
│  └─ led.py               # 控 LED（開/關/閃爍）
│
├─ http_agent.py           # 核心常駐程序：長輪詢伺服器拉指令、回 ACK、送 ping
│
├─ serve_hls.py            # （可選）一鍵啟動 HLS：spawn rpicam-vid|ffmpeg + 啟 http_hls.py
│
├─ stream/
│  ├─ __init__.py
│  └─ http_hls.py          # 超輕量 HTTP 伺服器：對外提供 HLS 靜態檔（8088）
│
├─ utils/
│  ├─ __init__.py
│  └─ http.py              # requests 包裝、重試、逾時、簽章（若有）
│
└─ 說明文件                 # 你自己的說明/指南
```

## 詳細說明

### 📁 config/ - 設定與能力宣告目錄
**用途**: 存放所有配置文件和設定載入邏輯

#### 📄 capabilities.json (靜態配置)
- **功能**: 定義此樹莓派硬體支援的裝置能力清單
- **格式**: JSON 陣列，每個元素包含：
  - `kind`: 裝置類型 (如 "light", "camera")
  - `name`: 顯示名稱 (如 "電燈", "監視錄影")
  - `slug`: 唯一識別碼 (如 "living-light", "front-cam")
  - `config`: 裝置特定配置 (如 GPIO pin、HLS 參數)
  - `order`: 顯示順序
  - `enabled`: 是否啟用
- **使用時機**: 系統啟動時載入，用於初始化硬體驅動
- **範例配置**:
  ```json
  {
    "kind": "light",
    "name": "電燈",
    "slug": "living-light",
    "config": { "pin": 17, "active_high": true },
    "order": 1,
    "enabled": true
  }
  ```

#### 📄 homepi.yml (動態配置)
- **功能**: 執行時環境設定，包含硬體配置和自動化規則
- **主要區塊**:
  - `gpio_factory`: GPIO 工廠設定 (預設 lgpio)
  - `devices`: 硬體裝置定義 (LED、按鈕、感測器等)
  - `auto_light`: 自動感光控制設定
- **特色**: 支援環境變數覆寫，可透過 `HOMEPI_CONFIG` 指定自訂配置檔
- **範例配置**:
  ```yaml
  gpio_factory: lgpio
  devices:
    - name: led_1
      kind: led
      pin: 17
      active_high: true
  auto_light:
    sensor: bh1750-1-23
    led: led_1
    on_below: 40
    off_above: 250
  ```

#### 📄 loader.py (配置載入器)
- **功能**: 統一配置載入邏輯
- **載入順序**:
  1. 環境變數 `HOMEPI_CONFIG` 指定的檔案
  2. 預設 `./config/homepi.yml`
  3. 回傳空字典 (fallback)
- **特色**: 支援 UTF-8 編碼，錯誤處理完善

### 📁 detect/ - 硬體偵測目錄
**用途**: 開機時自動偵測和識別連接的硬體裝置

#### 📄 registry.py (偵測整合器)
- **功能**: 整合所有硬體偵測模組的結果
- **偵測流程**:
  1. 載入 `capabilities.json` 模板配置
  2. 執行各偵測模組 (hat, i2c, one_wire)
  3. 去重處理 (以 kind+slug 為鍵)
- **錯誤處理**: 個別偵測器失敗不影響整體流程
- **回傳**: 完整的裝置能力清單

#### 📄 hat.py (HAT 擴充板偵測)
- **功能**: 偵測樹莓派 HAT (Hardware Attached on Top) 擴充板
- **偵測內容**: 型號、版本、功能特性
- **偵測方法**: 讀取 EEPROM 或 GPIO 狀態

#### 📄 i2c.py (I²C 裝置偵測)
- **功能**: 掃描 I²C 匯流排，識別連接的感測器
- **支援裝置**: 常見 I²C 感測器 (如 BH1750 光感測器)
- **偵測方法**: 掃描 I²C 位址範圍，嘗試通訊

#### 📄 one_wire.py (1-Wire 裝置偵測)
- **功能**: 偵測 1-Wire 匯流排上的裝置
- **常見裝置**: DS18B20 溫度感測器
- **偵測方法**: 掃描 1-Wire 匯流排，讀取裝置 ID

### 📁 devices/ - 硬體控制驅動目錄
**用途**: 實際控制硬體裝置的驅動程式

#### 📄 led.py (LED 控制驅動)
- **功能**: 控制 LED 燈具的開關、閃爍等操作
- **特色功能**:
  - 支援多顆 LED 同時控制
  - GPIO 配置靈活 (pin, active_high)
  - 非樹莓派環境的 no-op 模式
  - 陰影狀態維護 (離線時保持狀態記憶)
- **API**: `light_on()`, `light_off()`, `light_toggle()`, `is_on()`
- **配置來源**: 優先讀取 YAML 設定，回退到環境變數

#### 📄 camera.py (相機控制驅動)
- **功能**: 控制樹莓派相機模組進行 HLS 串流
- **核心功能**:
  - 啟動/停止 HLS 串流
  - 查詢相機狀態
  - 自動取得本機 IP 位址
  - 整合 rpicam-vid 和 ffmpeg
- **配置**: 解析度、FPS、分段時間等參數
- **串流格式**: HLS (.m3u8 + .ts 檔案)

### �� stream/ - 串流服務目錄
**用途**: 提供 HLS (HTTP Live Streaming) 串流服務

#### 📄 http_hls.py (HLS HTTP 伺服器)
- **功能**: 超輕量級 HTTP 伺服器，提供 HLS 靜態檔案服務
- **特色**:
  - CORS 跨域支援
  - 正確的 MIME 類型設定
  - 播放列表快取控制
  - 安全路徑處理
- **預設埠**: 8088
- **支援格式**: .m3u8 (播放列表), .ts (視訊片段)

### 📁 utils/ - 工具函式目錄
**用途**: 提供共用的工具函式和輔助功能

#### 📄 http.py (HTTP 工具)
- **功能**: HTTP 請求的封裝和工具函式
- **特色**: 重試機制、逾時處理、簽章驗證
- **用途**: 與主伺服器通訊 (ping, pull, ack)

### 📄 核心程式檔案

#### 📄 http_agent.py (主程式)
- **功能**: 系統核心常駐程序
- **主要職責**:
  - 長輪詢伺服器拉取指令
  - 執行硬體控制命令
  - 心跳上報和狀態同步
  - 本地排程管理
  - 自動感光控制
- **命令分發**: 透過 `COMMANDS` 字典映射命令到對應驅動函式
- **常駐模式**: 持續運行，定期檢查指令和狀態

#### 📄 serve_hls.py (HLS 啟動器)
- **功能**: 一鍵啟動 HLS 串流服務
- **流程**:
  1. 啟動 rpicam-vid 或 ffmpeg 進行視訊編碼
  2. 啟動 http_hls.py 提供 HTTP 服務
  3. 管理子程序生命週期
- **使用場景**: 需要即時視訊串流時

## 🔧 系統架構特點

### 1. **模組化設計**
- 各功能模組獨立，便於維護和擴展
- 清晰的職責分離 (偵測、控制、串流、配置)
- 低耦合、高內聚的設計原則

### 2. **配置驅動**
- 靜態配置 (capabilities.json) + 動態配置 (homepi.yml)
- 環境變數支援，便於不同環境部署
- 配置熱重載支援

### 3. **錯誤容錯**
- 硬體偵測失敗不影響系統啟動
- 非樹莓派環境的優雅降級
- 異常處理和日誌記錄

### 4. **自動化支援**
- 自動感光控制 (BH1750 → LED)
- 本地排程系統
- 心跳和狀態同步
- 背景任務管理

### 5. **串流整合**
- 完整的 HLS 串流解決方案
- 輕量級 HTTP 伺服器
- CORS 和快取優化
- 即時視訊傳輸

## 🚀 使用流程

### 系統啟動流程
1. **配置載入**: `http_agent.py` 載入 `capabilities.json` 和 `homepi.yml`
2. **硬體偵測**: 執行 `detect/` 模組掃描連接的硬體
3. **驅動初始化**: 根據配置初始化 `devices/` 中的硬體驅動
4. **服務啟動**: 啟動 HTTP 代理和 HLS 串流服務
5. **常駐運行**: 進入主循環，持續輪詢指令和執行任務

### 命令執行流程
1. **指令接收**: 從主伺服器拉取指令
2. **命令分發**: 透過 `COMMANDS` 字典找到對應驅動函式
3. **硬體控制**: 執行實際的硬體操作
4. **狀態回報**: 將執行結果回報給主伺服器
5. **日誌記錄**: 記錄操作過程和結果

### 自動化流程
1. **感測器讀取**: 定期讀取 BH1750 光感測器數值
2. **規則判斷**: 根據設定的閾值判斷是否需要開關燈
3. **硬體控制**: 自動控制 LED 開關
4. **狀態同步**: 將自動化狀態同步到主伺服器

## 📋 開發指南

### 新增硬體支援
1. 在 `devices/` 目錄新增驅動模組
2. 在 `capabilities.json` 中宣告裝置能力
3. 在 `http_agent.py` 的 `COMMANDS` 中註冊命令
4. 更新 `detect/` 模組以支援自動偵測

### 配置管理
1. 靜態配置寫在 `capabilities.json`
2. 動態配置寫在 `homepi.yml`
3. 使用 `config/loader.py` 統一載入
4. 支援環境變數覆寫

### 除錯技巧
1. 檢查 `http_agent.py` 的日誌輸出
2. 驗證硬體連接和 GPIO 配置
3. 測試個別驅動模組的功能
4. 檢查網路連線和伺服器通訊

## 🔍 技術細節

### GPIO 控制
- 使用 `gpiozero` 函式庫
- 支援 `lgpio` 和 `rpi.gpio` 後端
- 配置驅動的 pin 和 active_high 設定

### HLS 串流
- 使用 `rpicam-vid` 進行硬體編碼
- 透過 `ffmpeg` 轉換為 HLS 格式
- 輕量級 HTTP 伺服器提供檔案服務

### 網路通訊
- HTTP 長輪詢機制
- 心跳包維持連線
- 命令確認 (ACK) 機制

### 自動化控制
- 背景執行緒監控感測器
- 可配置的閾值和規則
- 平滑的狀態轉換

