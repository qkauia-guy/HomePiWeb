<!-- markdownlint-disable -->

##### 將專案裡`pi_agent`目錄移動到樹梅派

1. 將專案資料整個移動到樹梅派目錄下 `/home/<你的username>`

- windows 移動方式( 擇一 )：

  - `robocopy C:\Users\職前\HomePiWeb\pi_agent \\<樹梅派IP位置>\pi_agent /MIR`
  - 使用`WSL`移動 : `rsync -avz /mnt/c/Users/職前/HomePiWeb/pi_agent/ <Hostname>:/home/<pi5UserName>/pi_agent/`
  - 手動移動( 建議使用上面整個資料夾移動方式 )

2. 安裝套件( 目前 IOT 有使用到 )

```bash
# apt 套件
sudo apt-get install -y python3-gpiozero python3-lgpio python3-smbus python3-libgpiod i2c-tools
sudo apt install nginx -y
sudo apt update && sudo apt install -y pigpio
# pip 套件
pip3 install smbus2 pyyaml
# 環境變數 套件
pip install python-dotenv
# 溫濕度感測　套件
pip install adafruit-circuitpython-dht
# 跨平台的系統資訊工具，可以取 CPU 使用率、記憶體狀態等。
pip install psutil
```

##### pigpio/pigpiod 安裝與啟用（伺服最佳化）

為了讓伺服角度更穩定、到位更精準，建議改用 pigpio 提供的驅動（取代軟體 PWM）。

1. 安裝與啟動 pigpio daemon

```bash
sudo apt update && sudo apt install -y pigpio
sudo systemctl enable --now pigpiod
sudo systemctl status pigpiod --no-pager | cat
```

2. 本機測試時指定使用 pigpio（非 systemd）

```bash
GPIOZERO_PIN_FACTORY=pigpio python3 /home/$USER/pi_agent/test_locker.py
# 或啟動 Agent：
GPIOZERO_PIN_FACTORY=pigpio python3 /home/$USER/pi_agent/http_agent.py
```

3. 以 systemd 執行時的設定

- 專案已在 `說明文件/systemd檔案/homepi-agent@.service` 中加入：
  - `[Unit]` 的 `After=pigpiod.service`、`Wants=pigpiod.service`
  - `[Service]` 的 `Environment=GPIOZERO_PIN_FACTORY=pigpio`

套用步驟（首次或更新 service 內容後）：

```bash
sudo systemctl daemon-reload
sudo systemctl restart homepi-agent@<username>.service
journalctl -u homepi-agent@<username>.service -f | cat
```

4. 驗證角度穩定度（可選）

```bash
GPIOZERO_PIN_FACTORY=pigpio python3 - <<'PY'
from gpiozero import AngularServo
import time
sv = AngularServo(18, min_angle=0, max_angle=180, min_pulse_width=500/1_000_000, max_pulse_width=2400/1_000_000)
for a in (0, 45, 90, 135, 180):
    print('angle ->', a)
    sv.angle = a
    time.sleep(1.5)
sv.detach()
PY
```

> 提醒：伺服供電請與樹梅派共地；若仍不穩，檢查電源、線材與 `servo_min_us/servo_max_us` 校正。

##### 樹梅派環境變數設定:

1. `cd pi_agent`
2. `sudo nano .env`
3. 複製變數格式[env 規格範本](../env)
4. 修改替換自己的**裝置序號**,**裝置 TOKEN**

###### 權限設定( 基本上在 user 目錄下應該不會有權限問題 )

```bash
# 改變一個檔案或目錄的所有權
sudo chown -R richard:richard /home/richard/pi_agent
#
sudo adduser richard dialout
# 加入 gpio 群組
sudo adduser richard gpio
```

> dialout 群組是 Linux 系統中一個常見的特殊群組，其主要作用是讓使用者能夠存取串列埠（Serial Port）和數據機（Modem）。
> dialout 群組賦予使用者存取串列埠（如 /dev/ttyS0、/dev/ttyUSB0）的權限。這對於與樹莓派的 GPIO 腳位或外部硬體（如 Arduino）通訊非常重要，因為這些通訊通常會透過串列埠進行。

> gpio 群組賦予使用者直接控制樹莓派 GPIO 腳位的權限。許多 Python GPIO 函式庫，如 gpiozero 和 RPi.GPIO，都需要使用者屬於這個群組才能正常操作 GPIO 腳位。

##### 虛擬環境建立流程(conda):

1.

```shell
# 下載 Miniforge (64-bit ARM 版本，適用 Raspberry Pi 4/5)
wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh

# 給予執行權限
chmod +x Miniforge3-Linux-aarch64.sh

# 安裝到使用者目錄 (例如 ~/miniforge3)
./Miniforge3-Linux-aarch64.sh
```

2.

```
source ~/miniforge3/etc/profile.d/conda.sh
```

3.

```
conda create -n HomePiWed python=3.11 -y
```

4.

```
conda activate HomePiWed
```

#### [上一步:01 本地環境設定](01本地環境設定.md)

#### [下一步:03 樹梅派環境設定](03樹梅派序號綁定.md)
