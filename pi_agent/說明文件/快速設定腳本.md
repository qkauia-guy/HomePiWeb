# 快速設定 HLS 自動清理腳本

## 一鍵設定命令

將以下命令複製到樹莓派終端機執行，**記得先替換 `你的使用者名稱`**：

```bash
# 設定變數（請修改為你的實際使用者名稱）
USERNAME="你的使用者名稱"

# 切換到正確目錄
cd /home/$USERNAME/pi_agent

# 建立清理腳本
cat > cleanup_hls.sh << EOF
#!/bin/bash
# HLS 自動清理腳本
# 刪除超過 5MB 的異常 HLS 片段檔案

STREAM_DIR="/home/$USERNAME/pi_agent/stream"
MAX_SIZE="5M"

echo "\$(date): 開始清理 HLS 檔案..."

# 找出超過 5MB 的 .ts 檔案
LARGE_FILES=\$(find "\$STREAM_DIR" -name "seg_*.ts" -size +\$MAX_SIZE -type f)

if [ -n "\$LARGE_FILES" ]; then
    echo "發現異常大的檔案："
    echo "\$LARGE_FILES"
    
    # 刪除這些檔案
    echo "\$LARGE_FILES" | xargs rm -f
    echo "已刪除異常大的 HLS 片段檔案"
else
    echo "沒有發現異常大的檔案"
fi

# 顯示目前 stream 目錄大小
CURRENT_SIZE=\$(du -sh "\$STREAM_DIR" | cut -f1)
echo "目前 stream 目錄大小: \$CURRENT_SIZE"

echo "\$(date): HLS 清理完成"
EOF

# 設定執行權限
chmod +x cleanup_hls.sh

# 測試腳本
echo "測試腳本執行..."
./cleanup_hls.sh

# 設定自動執行（每 10 分鐘）
echo "*/10 * * * * /home/$USERNAME/pi_agent/cleanup_hls.sh >> /home/$USERNAME/pi_agent/cleanup.log 2>&1" | crontab -

# 驗證設定
echo "驗證 crontab 設定："
crontab -l

echo "設定完成！"
echo "清理日誌位置：/home/$USERNAME/pi_agent/cleanup.log"
echo "手動執行：./cleanup_hls.sh"
```

## 使用步驟

1. **修改使用者名稱**：將 `你的使用者名稱` 替換為實際的使用者名稱
2. **複製完整命令**：複製上面的整個命令區塊
3. **在終端機執行**：貼上並執行
4. **檢查結果**：確認沒有錯誤訊息

## 驗證設定

執行完成後，可以檢查：

```bash
# 檢查腳本是否存在
ls -la cleanup_hls.sh

# 檢查 crontab 設定
crontab -l

# 手動執行一次測試
./cleanup_hls.sh

# 查看日誌
cat cleanup.log
```

## 注意事項

- 請確保在正確的目錄（`/home/你的使用者名稱/pi_agent`）執行
- 如果遇到權限問題，可能需要使用 `sudo`
- 設定完成後，腳本會每 10 分鐘自動執行一次
